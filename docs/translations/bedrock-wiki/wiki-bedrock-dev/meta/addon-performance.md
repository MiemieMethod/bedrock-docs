---
title: 附加包性能
mentions:
    - SirLich
    - Joelant05
    - MedicalJewel105
    - TheItsNameless
    - SmokeyStack
description: 学习如何优化你的附加包。
---

/// warning
本页面主要基于来自多个来源的社区反馈整理而成。因此，某些信息可能是概括性的、主观的或相互矛盾的。在优化附加包时，请始终运用自己的最佳判断。此页面不能替代在各种设备上测试附加包。
///

附加包的性能至关重要，因为即使是技术上最出色的附加包，如果大多数玩家无法体验，也基本无用。在开发附加包时，始终应考虑到许多基岩版玩家将在性能远低于开发设备的设备上体验你的附加包。这对于移动用户尤其如此。因此，附加包的开发应考虑性能，并在可能的情况下在低端设备上进行性能测试。

本指南是基于基岩版各个子系统的特定性能考虑的非详尽列表。没有任何单一观点应被视为绝对规则。相反，这些性能考虑应帮助你识别潜在的改进领域。

## 生物群落和特征

### 生物群落

-   生物群落系统通常效率较高
-   高度图的大值通常能够优雅处理
-   组件`climate`会产生大量粒子风暴

### 特征

-   生物群落通常比特征生成造成的延迟更少。
-   每个区块的多块特征可以以较低的性能成本实现数百次迭代。
-   每个区块的多块特征达到数千次迭代会对游戏体验产生负面影响。
-   每个区块的单块特征可以以较低的性能成本实现数十万次迭代。
-   每个区块的特征实例数以千计几乎没有成本。
-   每个区块的特征实例数达到数万时，会对区块加载产生明显影响。
-   每个区块的特征实例数达到数十万时，会使区块加载速度变得无法忍受。

## 方块

### 材料

-   渲染所需的最低材料类型应始终被利用
> `alpha_blend`的性能差于`alpha_test`，而`alpha_test`的性能又差于`opaque`

### 数量和类型

-   应避免和最小化流动液体

### 更新

-   应最小化方块更新

## 命令

### 数量和类型

-   应最小化每个刻运行的命令数量
> 每个刻运行的`/effect`和`/gamemode`是可以避免的，并且会对性能产生显著影响
-   在运行时应避免大规模克隆、填充和结构加载
> 将这些较大的操作拆分为多个命令并分散在多个刻中可以避免延迟峰值，考虑使用结构加载动画

### 选择器

-   应注意确保一个函数不会在过多实体上执行，从而导致过多执行
-   执行记分板命令的成本超过多次运行实体选择器的成本
-   使用`c=1`确保选择器在找到一个实体时停止可能会提高性能
-   当使用相同选择器执行多个命令时，使用函数而不是重复解析相同选择器

### 标签与记分板

-   在大规模使用时，记分板的性能优于标签

## 实体

-   实体通常对子系统的性能影响最大，因此应尽可能减少使用

### 组件

-   飞行生物的路径寻找具有显著的性能成本
-   飞行生物通常会遇到性能问题
> 如果可能，考虑通过动画伪装飞行生物

### 虚拟实体

-   虚拟实体的性能影响通常与真实实体相当，除非排除像路径寻找这样的重型组件

### 几何体

#### 骨骼

-   骨骼数量对性能没有观察到影响

#### 元素

-   元素数量通常不是问题，除非在极端情况下达到数千个元素

### 材料

-   应始终使用实现所需效果的最低材料
-   如果有疑问，请参考材料定义文件，以了解各种材料的成本，同时考虑材料继承系统

### 数量

-   在任何给定时间加载的实体应最小化
> 最佳数量低于30

## 光照

### 地图考虑

-   空心区域会因光照计算而导致延迟，即使你看不见它们
> 通过填充未使用的封闭区域来避免这一点
-   将地图保持在白天或黑夜状态将避免光照重新计算

### 光源

-   基岩版的光照是动态计算的，这意味着不同光源的性能成本不同
> 光块是性能最好的，因为它们没有粒子、渲染和特定状态逻辑

> 火把是一个小的性能问题，因为它们会发出粒子、渲染，并且有依赖于连接方块的特定状态逻辑

> 具有最小组件的自定义光块在性能和美观之间是一个合理的折衷

#### 比较表

|     光源      | 分数 | 红石更新 | 动画纹理 | 光照更新 | 刻更新 | 粒子 | 渲染 |
|---------------:|:-----:|:--------:|:--------:|:--------:|:------:|:-----:|:-----:|
|     光块      |   1   |   假     |   假     |   真     |   假   |  假  |  假  |
|     灯笼      |   4   |   假     |   真     |   真     |   真   |  假  |  真  |
|   自定义块    |   2   |   假     |   假     |   真     |   假   |  假  |  真  |
|     蘑菇      |   3   |   假     |   假     |   真     |   真   |  假  |  真  |
|   红石灯      |   3   |   真     |   假     |   真     |   假   |  假  |  真  |
|     荧光石    |   3   |   真     |   假     |   真     |   真   |  假  |  真  |
|    海洋灯      |   4   |   假     |   真     |   真     |   真   |  假  |  真  |
|     火把      |   4   |   假     |   假     |   真     |   真   |  真  |  真  |
| 红石火把      |   5   |   真     |   假     |   真     |   真   |  真  |  真  |

## Molang

### 递归

-   尽可能减少递归的使用
-   强烈嵌套循环结构会导致性能问题
-   尽可能使用`break`跳出循环

### 结构体

-   避免使结构体过深，因为每层都有性能成本

### 变量

-   尽可能使用临时变量，以最小化加载到内存中的变量数量
-   考虑根据脚本类型计算变量的频率

## 纹理

### texture_list.json

-   大量纹理会严重影响游戏性能。创建一个[`texture_list.json`](../concepts/textures-list.md)文件。

### 数量

-   不应使用超过3000个纹理
> 这是由于Render Dragon施加的限制

> Render Dragon的纹理数量限制为4096，而截至1.16版本有800个原版纹理

### 分辨率

-   最大纹理分辨率为16384x16384
-   推荐的最大纹理分辨率为4096x4096，以保持与低端设备的兼容性
-   请记住，纹理是合并的，较大的纹理可能会干扰低端设备上的合并生成
-   仅在需要传达细节的距离时制作尽可能大的纹理

## 交易

村民交易在60笔或更多时会导致所有设备的性能问题甚至崩溃。避免为一个实体设置大量交易。
解决此问题的最佳方法是将交易分成两部分，转移到另一个村民或自定义实体/NPC上，30笔交易是经过测试的安全数字。
*可能是JSON UI问题*

## 声音

### 数量

-   注册的声音总数会对性能产生影响

### 压缩

-   声音压缩对包大小极为有利
-   这在较旧和低功率设备上尤其明显，例如Switch
-   基岩版使用的FMod简单API会将所有声音解压缩为WAV格式，然后加载到RAM中，这在这方面不会提高CPU性能
> 如果音频是流式传输，则不会发生这种情况

### 流式传输

-   一般建议，大小超过500kb或长度超过1分钟的声音应进行流式传输

## 红石

### 区块边界

-   应避免跨越红石的区块边界

### 命令方块

-   创建大型命令方块链时，垂直堆叠并保持在单个区块内
-   在可能的情况下，尽量减少命令方块的使用，优先使用函数和行为

## 刻区

-   总区块数量比刻区更为重要
-   动态区域应避免，除非必要
-   最佳实践是将刻区最小化为一个区块
> 所有始终开启的红石应适应此刻区
-   当不再需要时卸载刻区，通过/testforblock进行测试

## 文件

-   大量文件会严重影响游戏性能。创建一个[`contents.json`](../concepts/contents.md)文件。
