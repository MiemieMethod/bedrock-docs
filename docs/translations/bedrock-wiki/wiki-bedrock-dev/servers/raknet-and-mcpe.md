---
title: RakNet与MCPE
mentions:
    - ZestiiSpaghett
    - MedicalJewel105
    - SmokeyStack
    - ThomasOrs
    - Adrian8115
    - ismaileke
    - Tom-Teclador
description: MCBE的RakNet协议。
---

Minecraft基岩版使用一种称为[RakNet](http://www.jenkinssoftware.com/)的协议。与Minecraft Java版不同，基岩版在19132端口上使用UDP。

您可以在[这里](../servers/server-software.md#active-software)找到Minecraft基岩版服务器软件的列表。

## RakNet注意事项

- 所有字符串前都有一个无符号短整型，表示其长度。
- 离线消息ID始终为：00ffff00fefefefefdfdfdfd12345678（十六进制）——这组字节将被称为_Magic_。
- 离线消息ID与未连接消息一起发送，例如未连接的ping和pong。
- RakNet使用的GUID长度为8字节。
- 第一个字节用于标识消息类型。

## 数据类型

| 类型           | 大小 | 范围           | 备注                                                          |
| -------------- | ---- | --------------- | -------------------------------------------------------------- |
| 字节           | 1    | 0-255           | 无符号整数                                                    |
| 长整型         | 8    | -2^63到2^63-1  | 有符号64位整数                                              |
| Magic          | 16   |                 | 00ffff00fefefefefdfdfdfd12345678 - 始终为这些字节          |
| 短整型         | 2    | -32768到32767  |                                                                |
| 无符号短整型   | 2    | 0到65535       |                                                                |
| 字符串         | N/A  | N/A             | 以短整型为前缀的字符串，表示长度。                             |
| 布尔值         | 1    | 0-1             | 0x00为假，0x01为真                                           |
| 地址           | 7    |                 | 1字节用于IP版本4/6，4字节用于IP，2字节用于端口             |
| uint24le       | 3    |                 | 3字节小端无符号整数                                          |

## 目录

-   [x] 未连接的Ping
-   [x] 未连接的Pong
-   [x] 打开连接请求1
-   [x] 打开连接回复1
-   [x] 打开连接请求2
-   [x] 打开连接回复2
-   **从这里开始，RakNet连接已建立，所有RakNet消息都包含在[帧集数据包](https://wiki.vg/Raknet_Protocol#Frame_Set_Packet)中。**
-   [x] 连接请求
-   [x] 连接请求已接受
-   [x] 新的传入连接

### 未连接的Ping

Minecraft基岩版会向所有列出的服务器（以及本地网络）发送消息，以检查是否有可用游戏并获取游戏的MOTD。这些消息称为未连接的ping，格式如下：

`0x01 | 客户端存活时间（毫秒，unsigned long long） | magic | 客户端GUID`

### 未连接的Pong

在此消息之后，服务器将以未连接的pong进行响应。这些消息之所以未连接，是因为客户端尚未与服务器建立连接。未连接的pong格式如下：

`0x1c | 客户端存活时间（毫秒，来自之前的ping） | 服务器GUID | Magic | 字符串长度 | 版本（MCPE或MCEE用于教育版）；MOTD行1；协议版本；版本名称；玩家数量；最大玩家数量；服务器唯一ID；MOTD行2；游戏模式；游戏模式（数字）；端口（IPv4）；端口（IPv6）；`

示例：

`MCPE;专用服务器;527;1.19.1;0;10;13253860892328930865;基岩等级;生存;1;19132;19133;`

客户端似乎不使用游戏模式或游戏模式的数字值。

### 打开连接请求1 |→ 客户端→服务器

客户端在尝试加入服务器时发送此请求。

`0x05 | Magic | 协议版本（当前为11或0x0b） | RakNet空填充`

空填充似乎用于发现网络可以处理的最大数据包大小。

客户端将以递减的空填充向服务器发送此请求，直到服务器以

### 打开连接回复1 |→ 服务器→客户端

客户端尝试加入时，服务器将以此响应。

`0x06 | magic | 服务器GUID | 服务器是否有安全性（布尔值） | Cookie（uint32，如果服务器有安全性） | MTU大小（无符号短整型）`

这是客户端与服务器之间握手的第一部分。

### 打开连接请求2 |→ 客户端→服务器

客户端在收到打开连接回复1数据包后以此响应。

`0x07 | magic | Cookie（uint32，如果服务器有安全性） | 客户端支持安全性（布尔值，始终为假，对于原版客户端，如果服务器有安全性） | 服务器地址 | MTU大小（无符号短整型） | 客户端GUID（长整型）`

### 打开连接回复2 |→ 服务器→客户端

这是客户端与服务器之间握手的最后部分。

`0x08 | magic | 服务器GUID（长整型） | 客户端地址 | MTU大小 | 安全性（布尔值）`

**从这里开始，所有RakNet消息都包含在[帧集数据包](https://wiki.vg/Raknet_Protocol#Frame_Set_Packet)中。**

### 连接请求 |→ 客户端→服务器

这是客户端发送连接请求的部分。

`0x09 | 客户端GUID（长整型） | 请求时间戳（长整型） | 安全性（布尔值）`

### 连接请求已接受 |→ 服务器→客户端

服务器在响应传入连接请求时发送此数据包。

`0x10 | 客户端地址 | 系统索引（短整型，未知其作用。0作为值（Minecraft客户端发送47）） | 系统地址（[]地址） | Ping时间（长整型） | Pong时间（长整型）`

### 新的传入连接 |→ 客户端→服务器

我们的RakNet连接现在完全成功。

`0x13 | 服务器地址 | 内部地址（[20（可能是10）]地址）（我使用255.255.255.255:0） | Ping时间（长整型） | Pong时间（长整型）`

### 注意：

接下来的两个数据包（以及第一个Minecraft协议数据包）都是由原版客户端一起发送的。RakNet协议也允许它们单独发送，但具有自定义RakNet实现的服务器可能并不总是处理这种情况，因为在原版客户端中从未发生这种情况。

### 新的传入连接

客户端在响应连接请求已接受时发送此数据包。

`0x13 | 服务器地址（uint8） | 客户端机器地址（地址[10]，Minecraft仅发送一个IPv6，并与占位符一起发送（见下文），而不是其他9个） | 客户端发送时间（uint64） | 服务器发送时间（uint64）`

占位符用于其他客户端机器地址（即内部地址）：

> 0xd4 0x0b 0xa7 0x86 0xdd 0x98 0x33 0x00 0x00
> 每个字节替换9个缺失的客户端机器地址中的一个。

发送此数据包后，您必须定期发送连接ping以保持连接活跃。服务器有时也会发送连接ping，回应时发送连接pong。

### 连接Ping

客户端在新的传入连接后立即发送此数据包。此数据包应作为不可靠数据包发送。客户端/服务器将以连接pong对此进行响应。

`0x00 | 自启动以来的时间（uint64）`

### 连接Pong

客户端或服务器在收到连接ping后发送此数据包。此数据包应作为不可靠数据包发送。

`0x00 | 客户端自启动以来的时间（uint64） | 服务器自启动以来的时间（uint64）`

## 资料来源

::: tip
如果您感兴趣并想了解更多信息，这里是基岩协议和RakNet的文档：

[Mojang官方协议文档](https://github.com/Mojang/bedrock-protocol-docs)

[RakNet协议文档](https://wiki.vg/Raknet_Protocol)

[另一个RakNet协议文档](https://github.com/vp817/RakNetProtocolDoc)
:::

此页面正在进行中，欢迎贡献，因为它仍在完善中。